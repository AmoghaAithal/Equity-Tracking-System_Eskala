
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Formula Manager</title>

    <!-- Web font that matches the screenshot -->
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- Page styles (keeps the look in your screenshot) -->
    <link rel="stylesheet" href="/web/styles/formula-manager.css" />
    <!-- Shared Eskala form navbar styles -->
    <link rel="stylesheet" href="/web/styles/form-navbar.css" />
  </head>
  <body>
    <!-- FORM NAVBAR (shared) -->
    <nav class="esk-nav" role="navigation" aria-label="Primary">
      <div class="esk-nav__inner">
        <!-- Brand -->
        <div class="esk-nav__brand" id="esk-form-brand">
          <img src="/Assets/Eskala-Logo.png" alt="" />
          <span>Eskala</span>
        </div>

        <div class="esk-nav__spacer"></div>

        <!-- Language Dropdown -->
        <div class="esk-nav__group">
          <button
            class="esk-nav__btn"
            type="button"
            data-menu="lang"
            aria-haspopup="true"
            aria-expanded="false"
            aria-controls="menu-lang"
          >
            English ▾
          </button>
          <div class="esk-nav__menu" id="menu-lang" role="menu" hidden>
            <a href="#" role="menuitem" data-lang="en">English</a>
            <a href="#" role="menuitem" data-lang="es">Español</a>
          </div>
        </div>

        <!-- Back/Home -->
        <a href="/web/Dashboard.html" id="esk-form-home" class="esk-nav__btn esk-nav__btn--ghost">← Home</a>
      </div>
    </nav>

    <!-- Thin completion progress bar -->
    <div class="esk-form-progress">
      <div class="esk-form-progress__bar" id="esk-form-progress-bar"></div>
    </div>

    <div class="container">
      <header>
        <div class="brand">
          <img src="/Assets/Eskala-Logo.png" alt="Eskala Logo" class="logo" />
        </div>

        <h1 data-en="Formula Manager" data-es="Gestor de Fórmulas">
          Formula Manager
        </h1>

        <p
          data-en="Manage calculation formulas for auto-calculated fields"
          data-es="Administrar fórmulas de cálculo para campos auto-calculados"
        >
          Manage calculation formulas for auto-calculated fields
        </p>

        <hr class="accent-line" />
      </header>

      <div class="table-container">
        <h2 data-en="Active Formulas" data-es="Fórmulas Activas">
          Active Formulas
        </h2>

        <div id="formulas-loading" class="loading">Loading formulas...</div>
        <div id="formulas-no-data" class="no-data" style="display: none">
          No formulas found
        </div>

        <table
          id="formulas-table"
          class="table table--wide"
          style="display: none"
        >
          <thead>
            <tr>
              <th>Field Name</th>
              <th>Field Label</th>
              <th>Formula Expression</th>
              <th>Description</th>
              <th>Status</th>
              <th>Last Updated</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="formulas-tbody"></tbody>
        </table>

        <hr class="section-divider" />

        <h2 data-en="Formula Change History" data-es="Historial de Cambios">
          Formula Change History
        </h2>

        <div id="history-loading" class="loading">Loading history...</div>
        <div id="history-no-data" class="no-data" style="display: none">
          No history found
        </div>

        <table
          id="history-table"
          class="table table--wide"
          style="display: none"
        >
          <thead>
            <tr>
              <th>Field Name</th>
              <th>Old Formula</th>
              <th>New Formula</th>
              <th>Changed By</th>
              <th>Changed At</th>
              <th>Reason</th>
            </tr>
          </thead>
          <tbody id="history-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Edit Formula Modal -->
    <div id="edit-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 data-en="Edit Formula" data-es="Editar Fórmula">Edit Formula</h2>
          <button id="close-modal" class="close-btn" aria-label="Close">
            &times;
          </button>
        </div>

        <form id="edit-formula-form">
          <input type="hidden" id="edit-formula-id" />
          <input type="hidden" id="edit-field-name" />
          <input type="hidden" id="edit-formula-expression" />

          <div class="form-group">
            <label
              for="edit-field-label"
              data-en="Field Label"
              data-es="Etiqueta del Campo"
              >Field Label</label
            >
            <input type="text" id="edit-field-label" readonly />
          </div>

          <div class="form-group">
            <label data-en="Formula Builder" data-es="Constructor de Fórmulas">
              Formula Builder
            </label>
            <div id="formula-builder-container" class="formula-builder">
              <!-- Formula components will be inserted here -->
            </div>
            <div class="formula-preview-container">
              <strong>Preview:</strong>
              <code id="formula-preview"></code>
            </div>
            <small class="hint"
              >You can only edit operators and number values. Variables are fixed and cannot be changed, added, or removed.</small
            >
          </div>

          <div class="form-group">
            <label
              for="edit-description"
              data-en="Description"
              data-es="Descripción"
              >Description</label
            >
            <textarea id="edit-description" rows="2" readonly></textarea>
          </div>

          <div class="form-group">
            <label
              for="edit-reason"
              data-en="Reason for Change (Required)"
              data-es="Motivo del Cambio (Obligatorio)"
            >
              Reason for Change (Required)
            </label>
            <textarea
              id="edit-reason"
              rows="2"
              required
              placeholder="Explain why this formula is being updated"
            ></textarea>
          </div>

          <hr class="accent-line" />

          <div class="row">
            <button type="submit" class="btn btn--primary">Save Changes</button>
            <button type="button" id="cancel-edit" class="btn btn--neutral">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Language handler (before navbar JS) -->
    <script>
      (function () {
        const LANG_KEY = "eskala_lang";

        // Global hook used by form-navbar.js
        window.setLanguage = function setLanguage(lang) {
          lang = lang === "es" ? "es" : "en";

          // Update all visible text
          document.querySelectorAll("[data-en]").forEach((el) => {
            const text = el.getAttribute("data-" + lang);
            if (text != null) el.textContent = text;
          });

          // Update placeholders
          document.querySelectorAll("[data-en-placeholder]").forEach((el) => {
            const ph = el.getAttribute("data-" + lang + "-placeholder");
            if (ph != null) el.placeholder = ph;
          });

          // Sync <html lang>
          document.documentElement.setAttribute("lang", lang);

          // Update the dropdown label immediately
          const btn = document.querySelector('[data-menu="lang"]');
          if (btn)
            btn.innerHTML = (lang === "es" ? "Español" : "English") + " ▾";

          // Translate & preserve QS for navbar Home link
          const home = document.getElementById("esk-form-home");
          if (home) {
            const qs = location.search || "";
            home.textContent = lang === "es" ? "← Inicio" : "← Home";
            home.setAttribute("href", "/web/Dashboard.html" + qs);
          }

          // Back link in page content (also preserve QS)
          const back = document.querySelector(".back-link");
          if (back) {
            const qs = location.search || "";
            back.textContent =
              lang === "es" ? "← Volver al Panel" : "← Back to Dashboard";
            back.setAttribute("href", "/web/Dashboard.html" + qs);
          }
        };

        // Apply the saved/default language before navbar JS runs
        const saved = localStorage.getItem(LANG_KEY) || "en";
        window.setLanguage(saved);
      })();
    </script>

    <!-- Shared navbar behavior -->
    <script src="/js/form-navbar.js" defer></script>

    <!-- Page logic -->
    <script src="/js/formula-manager.client.js"></script>
  </body>
</html>