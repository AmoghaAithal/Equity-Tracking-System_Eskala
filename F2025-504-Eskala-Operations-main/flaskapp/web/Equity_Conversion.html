
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Equity Conversion Request</title>

    <!-- Base/shared layout styles -->
    <link rel="stylesheet" href="/web/styles/Loan_vs_Investments.html" />
    <!-- Bring in the date/select look you prefer -->
    <link rel="stylesheet" href="/web/styles/Equity_Conversion.css" />
    <link rel="stylesheet" href="/web/styles/form-navbar.css" />
    <style>
      /* Page-specific (admin card only) */
      .admin-link-container {
        display: none;
        text-align: center;
        margin-top: 20px;
        padding: 15px;
        background: #f0f9ff;
        border: 2px solid #3b82f6;
        border-radius: 8px;
      }
      .admin-link-container.visible {
        display: block;
      }
      .admin-notice {
        color: #1e40af;
        font-size: 13px;
        margin-bottom: 10px;
        font-weight: 500;
      }
      .admin-link {
        display: inline-block;
        padding: 10px 20px;
        background: #3b82f6;
        color: #fff;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 600;
        margin-top: 8px;
      }
      .admin-link:hover {
        background: #2563eb;
      }
    </style>
  </head>
  <body>
    <!-- FORM NAVBAR (identical style to dashboard) -->
    <nav class="esk-nav" role="navigation" aria-label="Primary">
      <div class="esk-nav__inner">
        <!-- Brand -->
        <a class="esk-nav__brand" id="esk-form-brand" href="#">
          <img src="/Assets/Eskala-Logo.png" alt="" />
          <span>Eskala</span>
        </a>

        <div class="esk-nav__spacer"></div>

        <!-- Language Dropdown -->
        <div class="esk-nav__group">
          <button
            class="esk-nav__btn"
            type="button"
            data-menu="lang"
            aria-haspopup="true"
            aria-expanded="false"
            aria-controls="menu-lang"
          >
            English ‚ñæ
          </button>
          <div class="esk-nav__menu" id="menu-lang" role="menu" hidden>
            <a href="#" role="menuitem" data-lang="en">English</a>
            <a href="#" role="menuitem" data-lang="es">Espa√±ol</a>
          </div>
        </div>

        <!-- Back/Home -->
        <a href="#" id="esk-form-home" class="esk-nav__btn esk-nav__btn--ghost"
          >‚Üê Home</a
        >
      </div>
    </nav>

    <!-- Thin completion progress bar -->
    <div class="esk-form-progress">
      <div class="esk-form-progress__bar" id="esk-form-progress-bar"></div>
    </div>
    <!-- FORM CONTENT -->
    <div class="eskala-equity-frame">
      <main class="main-content">
        <!-- Header / Logo -->
        <header class="form-header">
          <img
            class="eskala-header"
            src="/Assets/Eskala-Logo.png"
            alt="Eskala logo"
          />
          <!-- <button
            class="language-toggle"
            type="button"
            onclick="toggleLanguage()"
          >
            Espa√±ol
          </button> -->
        </header>

        <!-- Title -->
        <h1
          class="form-title"
          data-en="Equity Conversion Request"
          data-es="Solicitud de Conversi√≥n de Capital"
        >
          Equity Conversion Request
        </h1>

        <!-- Form -->
        <form
          id="conversion-form"
          class="form-container"
          method="post"
          action="#"
          novalidate
        >
          <!-- Community Bank Details -->
          <section>
            <h2
              class="section-title"
              data-en="Community Bank Details"
              data-es="Detalles del Banco Comunitario"
            >
              Community Bank Details
            </h2>

            <div class="input-group">
              <label
                for="bank-name"
                data-en="üè¶ Community Bank Name"
                data-es="üè¶ Nombre del Banco Comunitario"
                >üè¶ Community Bank Name</label
              >
              <input
                type="text"
                id="bank-name"
                placeholder="e.g., Banco Esperanza"
                data-en-placeholder="e.g., Banco Esperanza"
                data-es-placeholder="p. ej., Banco Esperanza"
              />
            </div>

            <div class="input-group">
              <label
                for="rtn-number"
                data-en="üßæ RTN Number (Tax ID)"
                data-es="üßæ N√∫mero RTN (ID Fiscal)"
                >üßæ RTN Number (Tax ID)</label
              >
              <input
                type="text"
                id="rtn-number"
                placeholder="e.g., 08011985123456"
                data-en-placeholder="e.g., 08011985123456"
                data-es-placeholder="p. ej., 08011985123456"
              />
            </div>

            <div class="input-group">
              <label
                for="representative-name"
                data-en="üë§ Representative Name"
                data-es="üë§ Nombre del Representante"
                >üë§ Representative Name</label
              >
              <input
                type="text"
                id="representative-name"
                placeholder="e.g., Ana Garc√≠a"
                data-en-placeholder="e.g., Ana Garc√≠a"
                data-es-placeholder="p. ej., Ana Garc√≠a"
              />
            </div>

            <div class="input-group">
              <label
                for="phone-number"
                data-en="üìû Phone Number"
                data-es="üìû N√∫mero de Tel√©fono"
                >üìû Phone Number</label
              >
              <input
                type="tel"
                id="phone-number"
                placeholder="e.g., +504 9876-5432"
                data-en-placeholder="e.g., +504 9876-5432"
                data-es-placeholder="p. ej., +504 9876-5432"
              />
            </div>
          </section>

          <!-- Original Loan Details -->
          <section>
            <h2
              class="section-title"
              data-en="Original Loan Details"
              data-es="Detalles del Pr√©stamo Original"
            >
              Original Loan Details
            </h2>

            <div class="input-group">
              <label
                for="loan-id"
                data-en="üÜî Loan ID"
                data-es="üÜî ID de Pr√©stamo"
                >üÜî Loan ID</label
              >
              <input
                type="text"
                id="loan-id"
                placeholder="e.g., LN-2025-0042"
                data-en-placeholder="e.g., LN-2025-0042"
                data-es-placeholder="p. ej., LN-2025-0042"
              />
            </div>

            <div class="input-group">
              <label
                for="original-loan-amount"
                data-en="üí∏ Original Loan Amount"
                data-es="üí∏ Monto Original del Pr√©stamo"
                >üí∏ Original Loan Amount</label
              >
              <div class="inline">
                <input
                  type="number"
                  id="original-loan-amount"
                  min="0"
                  step="0.01"
                  inputmode="decimal"
                  placeholder="e.g., 250,000.00"
                  data-en-placeholder="e.g., 250,000.00"
                  data-es-placeholder="p. ej., 250,000.00"
                />
                <span class="addon">L.</span>
              </div>
            </div>

            <div class="input-group">
              <label
                for="loan-approval-date"
                data-en="üìÖ Loan Approval Date"
                data-es="üìÖ Fecha de Aprobaci√≥n"
                >üìÖ Loan Approval Date</label
              >
              <input type="date" id="loan-approval-date" />
            </div>

            <div class="input-group">
              <label
                for="interest-paid"
                data-en="üí∏ Interest Paid"
                data-es="üí∏ Intereses Pagados"
                >üí∏ Interest Paid</label
              >
              <div class="inline">
                <input
                  type="number"
                  id="interest-paid"
                  min="0"
                  step="0.01"
                  inputmode="decimal"
                  placeholder="e.g., 12,500.00"
                  data-en-placeholder="e.g., 12,500.00"
                  data-es-placeholder="p. ej., 12,500.00"
                />
                <span class="addon">L.</span>
              </div>
            </div>

            <div class="input-group">
              <label
                for="loan-amount-remaining"
                data-en="üßÆ Loan Amount Remaining"
                data-es="üßÆ Saldo del Pr√©stamo"
                >üßÆ Loan Amount Remaining</label
              >
              <div class="inline">
                <input
                  type="number"
                  id="loan-amount-remaining"
                  min="0"
                  step="0.01"
                  inputmode="decimal"
                  placeholder="e.g., 137,500.00"
                  data-en-placeholder="e.g., 137,500.00"
                  data-es-placeholder="p. ej., 137,500.00"
                />
                <span class="addon">L.</span>
              </div>
            </div>

            <div class="input-group">
              <label
                for="repayment-frequency"
                data-en="üîÅ Repayment Frequency"
                data-es="üîÅ Frecuencia de Pago"
                >üîÅ Repayment Frequency</label
              >
              <select id="repayment-frequency" required>
                <option
                  value=""
                  data-en="Select frequency"
                  data-es="Seleccione frecuencia"
                >
                  Select frequency
                </option>
                <option value="monthly" data-en="Monthly" data-es="Mensual">
                  Monthly
                </option>
                <option
                  value="quarterly"
                  data-en="Quarterly"
                  data-es="Trimestral"
                >
                  Quarterly
                </option>
                <option value="annually" data-en="Annually" data-es="Anual">
                  Annually
                </option>
              </select>
            </div>
          </section>

          <!-- Proposed Conversion Terms -->
          <section>
            <h2
              class="section-title"
              data-en="Proposed Conversion Terms"
              data-es="T√©rminos Propuestos de Conversi√≥n"
            >
              Proposed Conversion Terms
            </h2>

            <div class="input-group">
              <label
                for="proposed-conversion-amount"
                data-en="üí∏ Proposed Conversion Amount"
                data-es="üí∏ Monto Propuesto a Convertir"
                >üí∏ Proposed Conversion Amount</label
              >
              <div class="inline">
                <input
                  type="number"
                  id="proposed-conversion-amount"
                  min="0"
                  step="0.01"
                  inputmode="decimal"
                  placeholder="e.g., 75,000.00"
                  data-en-placeholder="e.g., 75,000.00"
                  data-es-placeholder="p. ej., 75,000.00"
                />
                <span class="addon">L.</span>
              </div>
            </div>

            <div class="input-group">
              <label
                for="proposed-conversion-ratio"
                data-en="‚öñÔ∏è Proposed Conversion Ratio"
                data-es="‚öñÔ∏è Tasa de Conversi√≥n Propuesta"
                >‚öñÔ∏è Proposed Conversion Ratio</label
              >
              <input
                type="text"
                id="proposed-conversion-ratio"
                placeholder="e.g., 1 L = 1 Share"
                data-en-placeholder="e.g., 1 L = 1 Share"
                data-es-placeholder="p. ej., 1 L = 1 Acci√≥n"
              />
            </div>

            <div class="input-group">
              <label
                for="proposed-equity-percentage"
                data-en="üìä Proposed Equity %"
                data-es="üìä % de Capital Propuesto"
                >üìä Proposed Equity %</label
              >
              <div class="inline">
                <input
                  type="number"
                  id="proposed-equity-percentage"
                  min="0"
                  max="100"
                  step="0.01"
                  inputmode="decimal"
                  placeholder="e.g., 25"
                  data-en-placeholder="e.g., 25"
                  data-es-placeholder="p. ej., 25"
                />
                <span class="addon">%</span>
              </div>
            </div>

            <div class="input-group">
              <label
                for="desired-conversion-date"
                data-en="üìÖ Desired Conversion Date"
                data-es="üìÖ Fecha de Conversi√≥n Deseada"
                >üìÖ Desired Conversion Date</label
              >
              <input type="date" id="desired-conversion-date" />
            </div>
          </section>

          <!-- Attachments & Declaration -->
          <section>
            <h2
              class="section-title"
              data-en="Attachments and Declaration"
              data-es="Adjuntos y Declaraci√≥n"
            >
              Attachments and Declaration
            </h2>

            <div class="input-group">
              <label
                for="supporting-file"
                data-en="üìé Upload file (optional)"
                data-es="üìé Subir archivo (opcional)"
              >
                üìé Upload file (optional)
              </label>
              <input
                id="supporting-file"
                name="supporting_file"
                type="file"
                accept="application/pdf"
              />
            </div>

            <div class="input-group">
              <label
                for="comments"
                data-en="üìù Comments"
                data-es="üìù Comentarios"
                >üìù Comments</label
              >
              <textarea
                id="comments"
                name="comments"
                rows="4"
                placeholder="Any additonal comments "
                data-en-placeholder="Any additonal comments "
                data-es-placeholder="¬øAlg√∫n comentario adicional?"
              ></textarea>
            </div>

            <label class="confirm-row" for="confirm-accurate">
              <input
                type="checkbox"
                id="confirm-accurate"
                name="confirm_accurate"
                required
              />
              <span
                data-en="I confirm the submitted details are accurate"
                data-es="Confirmo que los datos enviados son correctos"
              >
                I confirm the submitted details are accurate
              </span>
            </label>

            <hr class="submit-divider" />
            <button
              type="submit"
              class="submit-button"
              data-en="SUBMIT"
              data-es="ENVIAR"
            >
              SUBMIT
            </button>

            <div
              id="conv-alert"
              class="alert"
              role="status"
              aria-live="polite"
            ></div>
          </section>
        </form>

        <!-- Staff and Banking Partner link -->
        <div
          class="admin-link-container"
          id="admin-link-container"
          style="display: none"
        >
          <div class="admin-notice" id="admin-notice">üîí View Submissions</div>
          <a href="/web/Equity_Conversion_Table.html" class="admin-link" id="admin-link"
            >View Submissions</a
          >
        </div>
      </main>
    </div>

    <!-- Language toggle -->
    <script>
      // (function ensureEnglishOnLoad() {
      //   document.querySelectorAll("[data-en]").forEach((el) => {
      //     const en = el.getAttribute("data-en");
      //     if (en) el.textContent = en;
      //   });
      //   document.querySelectorAll("[data-en-placeholder]").forEach((el) => {
      //     const ph = el.getAttribute("data-en-placeholder");
      //     if (ph) el.placeholder = ph;
      //   });
      // })();

      // let currentLang = "en";
      // function toggleLanguage() {
      //   currentLang = currentLang === "en" ? "es" : "en";
      //   document.querySelectorAll("[data-en]").forEach((el) => {
      //     const val = el.getAttribute(`data-${currentLang}`);
      //     if (val) el.textContent = val;
      //   });
      //   document.querySelectorAll("[data-en-placeholder]").forEach((el) => {
      //     const ph = el.getAttribute(`data-${currentLang}-placeholder`);
      //     if (ph) el.placeholder = ph;
      //   });
      //   const btn = document.querySelector(".language-toggle");
      //   if (btn) btn.textContent = currentLang === "en" ? "Espa√±ol" : "English";
      // }

      // Check user role and show appropriate link
      
      (async function checkUserRole() {
        try {
          const res = await fetch('/api/auth/check-session', { credentials: 'include' });
          const data = await res.json();
          
          if (data.is_authenticated) {
            // Get user role
            const roleRes = await fetch('/api/user/role', { credentials: 'include' });
            const roleData = await roleRes.json();
            
            const container = document.getElementById('admin-link-container');
            const notice = document.getElementById('admin-notice');
            const link = document.getElementById('admin-link');
            
            if (roleData.ok && roleData.role) {
              if (roleData.role === 'STAFF') {
                notice.textContent = 'üîí Eskala Staff Access';
                link.textContent = 'View All Conversion Submissions';
                container.style.display = 'block';
              } else if (roleData.role === 'COMMUNITY_REP') {
                notice.textContent = 'üìä View Your Submissions';
                link.textContent = 'View My Conversion Submissions';
                container.style.display = 'block';
              }
            }
          }
        } catch (err) {
          console.error('Error checking user role:', err);
        }
      })();
    </script>

    <!-- Language handler: must come before /form-navbar.js -->
    <script>
      (function () {
        const LANG_KEY = "eskala_lang";

        // Global hook used by form-navbar.js
        window.setLanguage = function setLanguage(lang) {
          lang = lang === "es" ? "es" : "en";

          // 1Ô∏è‚É£ Update all visible text
          document.querySelectorAll("[data-en]").forEach((el) => {
            const text = el.getAttribute("data-" + lang);
            if (text != null) el.textContent = text;
          });

          // 2Ô∏è‚É£ Update placeholders
          document.querySelectorAll("[data-en-placeholder]").forEach((el) => {
            const ph = el.getAttribute("data-" + lang + "-placeholder");
            if (ph != null) el.placeholder = ph;
          });

          // 3Ô∏è‚É£ Sync <html lang>
          document.documentElement.setAttribute("lang", lang);

          // 4Ô∏è‚É£ Optional: update the dropdown label immediately
          const btn = document.querySelector('[data-menu="lang"]');
          if (btn)
            btn.innerHTML = (lang === "es" ? "Espa√±ol" : "English") + " ‚ñæ";

          // Translate the navbar Home link
          const home = document.getElementById("esk-form-home");
          if (home) {
            home.textContent = lang === "es" ? "‚Üê Inicio" : "‚Üê Home";
          }
        };

        // Apply the saved or default language before navbar JS runs
        const saved = localStorage.getItem(LANG_KEY) || "en";
        window.setLanguage(saved);
      })();
    </script>

    <!-- Navbar logic -->
    <script src="/js/form-navbar.js" defer></script>
    <script src="/js/form-autosave.js"></script>
    <script src="/js/Equity_Conversion.client.js" defer></script>
  </body>
</html>